<!DOCTYPE HTML>
<html>
<head>
	<title><%= nom %> - G√©ocaching Jeux de Sophia 2018</title>
	<% include ./partials/head %>
</head>
<body>
	<% include ./partials/menu %>

	<div id="main" class="wrapper style4">

		<div id="content" class="container">
			<section>
				<header class="major">

					<img width="420px;" align="right" src="<%= photo %>" alt="<%= nom %>" style="margin-bottom:20px;">
					<img width="70px;" align="left" src="public/images/tb.jpg" style="margin-right:60px;"/>
					<h2 ><%= nom %></h2>
					<span class="byline"><%= fav %> üëç</span>
					<% if (holder != null) { %>
						<span class="byline">Dans les mains de <%= holder %>
						<br /><br />
						<!--<p><a href="/logtb?action=drop&id=<%= id %>" alt=" D√©posez le dans une cache !" style="float:left;" class="button small">&raquo;  D√©posez le dans une cache !</a></p>-->
					<% } %></span>
					<% if (holder==null && cacheId != null) { %>
						<span class="byline">Dans la cache <%= cacheName %> 
						<br /><br />
						<!--<p><a href="/logtb?action=grab&id=<%= id %>&cacheId=<%= cacheId %>" alt=" Vous l‚Äôavez trouv√© ? R√©cup√©rez le !" style="float:left;" class="button small">&raquo;  Vous l‚Äôavez trouv√© ? R√©cuperez le !</a></p>-->
					<% } %></span>
				</header>

				<p><h2>Objet Voyageur de <i><%= owner %></i></h2></p>
				<h3>Description</h3>
				<p><%- description %></p>
				<h3>Mission</h3>
				<p><%- mission %></p>

			</section>
			<br />

			<section>
				<h2>Historique des d√©placements (<span id="distance"></span> km)</h2>
				<div id="map"></div>

				<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfOPPHsPEYs7o8-xdYce1Bdxgmh-4TBAc&callback=initialize&libraries=geometry"
				type="text/javascript"></script>

				<script>
					locations = [
						<% objetsLogged.forEach(function(tblog) { %>
							<% if(tblog.get("Geocache")!=null) { %>
								[<%= tblog.get("Geocache").get("GPS").latitude %>,<%= tblog.get("Geocache").get("GPS").longitude %>, "<%= tblog.get("Geocache").get("Nom") %>", "<%= tblog.get("Geocache").get("Category") %>"], 
							<% } %>
					
						<% }); %>
					];

					function initialize() {
						map = new google.maps.Map(document.getElementById("map"), {
							mapTypeId: google.maps.MapTypeId.ROADMAP,
							center: new google.maps.LatLng(locations[0][0], locations[0][1]),
							zoom: 15
						});

						for (var i=0; i<locations.length; i++) {
							
							var myinfowindow = new google.maps.InfoWindow({
								content: '<h3 style="color:#83B348;">'+locations[i][2]+'</h3>'
							});

							var marker = new google.maps.Marker({
								position: new google.maps.LatLng(locations[i][0], locations[i][1]),
								map: map,
								title: locations[i][2],
								infowindow: myinfowindow,
								icon: 'public/images/'+locations[i][3]+'.gif'
							});
							
							google.maps.event.addListener(marker, 'click', function () {
								this.infowindow.open(map, this);
							});
						}
						
						// Chemin du TB
						var parcoursTB = [
							<% objetsLogged.forEach(function(tblog) { %>
								<% if(tblog.get("Geocache")!=null) { %>
									new google.maps.LatLng(<%= tblog.get("Geocache").get("GPS").latitude %>, <%= tblog.get("Geocache").get("GPS").longitude %>),
								<% } %>
							<% }); %>
						];

						var traceParcoursTB = new google.maps.Polyline({
							path: parcoursTB,
							geodesic: true,
							strokeColor: "#FF0000",
							strokeOpacity: 1.0,
							strokeWeight: 2
						});
						
						traceParcoursTB.setMap(map);

						setBoundsLeftSidebar(locations, 0.9);

						var distance = google.maps.geometry.spherical.computeLength(traceParcoursTB.getPath());
						distance = Number((distance / 1000).toFixed(1));
						document.getElementById('distance').innerHTML = distance;
					}
				</script>
				<br />
				<ul>
				<% objetsLogged.forEach(function(obj) { %>
					<% if (obj.get("Action") == "Created") { %>
						<li> <b><%= moment(obj.get("Date")).utcOffset(120).fromNow() %> le <%= moment(obj.get("Date")).utcOffset(120).format("LL [√†] LT") %></b> - <%= obj.get("Pseudo") %> a cr√©√© l'objet voyageur </i><% if(obj.get("PhotoUrl"))  { %> - <a href="<%= obj.get("PhotoUrl").replace(/^[a-zA-Z]{3,5}\:\/{2}[a-zA-Z0-9_.:-]+\//, ''); %>">photo</a><% } %></li>					
					<% } else if (obj.get("Action") == "drop") { %>
						<li> <b><%= moment(obj.get("Date")).utcOffset(120).fromNow() %> le <%= moment(obj.get("Date")).utcOffset(120).format("LL [√†] LT") %></b> - <%= obj.get("Pseudo") %> <%= obj.get("Action") %> dans la cache <a href="/geocache?id=<%= obj.get("cacheId") %>"><b><%= obj.get("cacheName") %></b></a> : <i><%= obj.get("Message") %></i><% if(obj.get("PhotoUrl"))  { %> - <a href="<%= obj.get("PhotoUrl").replace(/^[a-zA-Z]{3,5}\:\/{2}[a-zA-Z0-9_.:-]+\//, ''); %>">photo</a><% } %></li>
					<% } else { %>	
						<li> <b><%= moment(obj.get("Date")).utcOffset(120).fromNow() %> le <%= moment(obj.get("Date")).utcOffset(120).format("LL [√†] LT") %></b> - <%= obj.get("Pseudo") %> <%= obj.get("Action") %> a partir de la cache <a href="/geocache?id=<%= obj.get("cacheId") %>"><b><%= obj.get("cacheName") %></b></a> : <i><%= obj.get("Message") %></i><% if(obj.get("PhotoUrl"))  { %> - <a href="<%= obj.get("PhotoUrl").replace(/^[a-zA-Z]{3,5}\:\/{2}[a-zA-Z0-9_.:-]+\//, ''); %>">photo</a><% } %></li>
					<% } %> 
				<% }); %>
				</ul>
			</section>
			<br />
			<section>
				<h2>Fil de discussion concernant <%= nom %></h2>
				<div id="disqus_thread"></div>
				<script>
				var disqus_config = function () {
					// this.page.url = PAGE_URL; 
					this.page.identifier = <%= id %>;
				};

				(function() {
				var d = document, s = d.createElement('script');
				s.src = 'https://geocaching-jds.disqus.com/embed.js';
				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
				})();
				</script>
				<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			</section>

		</div>
	</div>
	<% include ./partials/footer %>

</body>
</html>